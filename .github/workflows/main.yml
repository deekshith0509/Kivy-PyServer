name: Build Kivy App for Android

on:
  push:
    branches:
      - main  # Change to your default branch if needed

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Stage 1: Environment Setup
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set Up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'  # Specify the Python version to use

      - name: Install Buildozer Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            python3-pip \
            python3-setuptools \
            python3-venv \
            openjdk-8-jdk \
            unzip \
            wget \
            curl \
            zip \
            libgl1-mesa-glx \
            libglu1-mesa \
            # Install Android SDK tools
            && wget https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip \
            && sudo mkdir -p /usr/local/android-sdk/cmdline-tools \
            && sudo unzip commandlinetools-linux-7583922_latest.zip -d /usr/local/android-sdk/cmdline-tools \
            && rm commandlinetools-linux-7583922_latest.zip \
            && sudo mv /usr/local/android-sdk/cmdline-tools/cmdline-tools /usr/local/android-sdk/cmdline-tools/latest

      - name: Set Android Environment Variables
        run: |
          echo "export ANDROID_HOME=/usr/local/android-sdk" >> $GITHUB_ENV
          echo "export PATH=\$PATH:\$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_ENV

      - name: Install Buildozer and Dependencies
        run: |
          pip install --upgrade pip
          pip install buildozer cython  # Install Buildozer and Cython

      # Stage 2: Build APK
      - name: Accept Licenses and Build APK
        run: |
          yes | sdkmanager --licenses  # Accept all SDK licenses
          yes | sdkmanager "platform-tools" "platforms;android-29"  # Install required SDK components
          yes | buildozer android update  # Update Buildozer
          buildozer -v android debug  # Build debug APK
          buildozer -v android release  # Build release APK (optional)

      # Stage 3: Upload APK
      - name: Upload APK to Repository
        uses: actions/upload-artifact@v3  # Updated to version v3
        with:
          name: Kivy-App-APK
          path: bin/*.apk  # Path where APKs are generated

      # Cleanup step (optional)
      - name: Cleanup
        run: |
          echo "Cleaning up..."
          # Add any cleanup commands if necessary
